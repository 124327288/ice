<!--
 **********************************************************************

 Copyright (c) 2003-2005 ZeroC, Inc. All rights reserved.

 This copy of Ice is licensed to you under the terms described in the
 ICE_LICENSE file included in this distribution.

 **********************************************************************
-->

<project name="test_Ice_operations" default="all" basedir=".">

    <!-- set global properties for this build -->
    <property name="top.dir" value="../../.."/>

    <!-- Include common definitions -->
    <import file="${top.dir}/config/common.xml"/>

    <target name="init" depends="config-init"/>

    <target name="generate" depends="init">
        <!-- Create the output directory for generated code -->
        <mkdir dir="${generated.dir}"/>
        <slice2javae outputdir="${generated.dir}">
            <fileset dir="." includes="Test.ice"/>
            <includepath>
                <pathelement path="${slice.dir}" />
            </includepath>
        </slice2javae>
    </target>

    <target name="compile" depends="generate">
        <mkdir dir="${class.dir}"/>
        <javac srcdir="${generated.dir}" destdir="${class.dir}" classpath="${lib.dir}" debug="${debug}"
	    target="1.1"/>
        <javac srcdir="." destdir="${class.dir}" classpath="${lib.dir}" excludes="generated/**" debug="${debug}"
	    target="1.1"/>
    </target>

    <target name="midlet-jar" if="midp">
	<ant dir="../common" target="compile"/>
        <mkdir dir="./tmp"/>
	<manifest file="MANIFEST.MF">
	    <attribute name="Microedition-Configuration" value="CLDC-1.0"/>
	    <attribute name="MIDlet-Name" value="Test Driver"/>
            <attribute name="MIDlet-Vendor" value="ZeroC"/>
            <attribute name="MIDlet-1" value="TestApplication, , TestApplication"/>
	    <attribute name="MIDlet-Version" value="1.0"/>
	    <attribute name="MicroEdition-Profile" value="MIDP-2.0"/>
        </manifest>

	<copy file="./config" todir="./classes"/>
	<jar destfile="./tmp/TestMIDlet.jar" manifest="./MANIFEST.MF" basedir="./classes"/>
	<jar destfile="./tmp/TestMIDlet.jar" manifest="./MANIFEST.MF" basedir="${lib.dir}" excludes="**/IceE.jar"
	    update="true"/>
	<jar destfile="./tmp/TestMIDlet.jar" manifest="./MANIFEST.MF" basedir="../common/classes" update="true">
	    <exclude name="./Client.class,./Server.class,./Collocated.class"/>
	</jar>

        <exec executable="${WTK}/bin/preverify">
           <arg line="-classpath ${WTKLIBS}"/>
            <arg line="-d ."/>
	    <arg line="./tmp/TestMIDlet.jar"/>
        </exec>
    </target>

    <!-- Write the descriptor files -->
    <target name="server-midlet" if="midp">
	<length property="jarfile-length" file="./TestMIDlet.jar"/>
	<jadfile file="server.jad">
	    <attribute name="MIDlet-Version" value="1.0"/>
            <attribute name="MIDlet-Vendor" value="ZeroC"/>
	    <attribute name="MIDlet-Jar-URL" value="TestMIDlet.jar"/>
	    <attribute name="MicroEdition-Profile" value="MIDP-2.0"/>
	    <attribute name="MicroEdition-Configuration" value="CLDC-1.1"/>
	    <attribute name="MIDlet-1" value="TestApplication, , TestApplication"/>
	    <attribute name="MIDlet-Jar-Size" value="${jarfile-length}"/>
	    <attribute name="MIDlet-Name" value="TestServer"/>
	    <attribute name="runclient" value="false"/>
	    <attribute name="runserver" value="true"/>
	    <attribute name="MIDlet-Permissions" 
		value="javax.microedition.io.Connector.socket, javax.microedition.io.Connector.serversocket"/>
        </jadfile>
    </target>

    <target name="client-midlet" if="midp">
	<length property="jarfile-length" file="./TestMIDlet.jar"/>
	<jadfile file="client.jad">
	    <attribute name="MIDlet-Version" value="1.0"/>
            <attribute name="MIDlet-Vendor" value="ZeroC"/>
	    <attribute name="MIDlet-Jar-URL" value="TestMIDlet.jar"/>
	    <attribute name="MicroEdition-Profile" value="MIDP-2.0"/>
	    <attribute name="MicroEdition-Configuration" value="CLDC-1.1"/>
	    <attribute name="MIDlet-1" value="TestApplication, , TestApplication"/>
	    <attribute name="MIDlet-Jar-Size" value="${jarfile-length}"/>
	    <attribute name="MIDlet-Name" value="TestServer"/>
	    <attribute name="runclient" value="true"/>
	    <attribute name="runserver" value="false"/>
	    <attribute name="MIDlet-Permissions" 
		value="javax.microedition.io.Connector.socket, javax.microedition.io.Connector.serversocket"/>
        </jadfile>
    </target>

    <target name="colloc-midlet" if="midp">
	<length property="jarfile-length" file="./TestMIDlet.jar"/>
	<jadfile file="colloc.jad">
	    <attribute name="MIDlet-Version" value="1.0"/>
            <attribute name="MIDlet-Vendor" value="ZeroC"/>
	    <attribute name="MIDlet-Jar-URL" value="TestMIDlet.jar"/>
	    <attribute name="MicroEdition-Profile" value="MIDP-2.0"/>
	    <attribute name="MicroEdition-Configuration" value="CLDC-1.1"/>
	    <attribute name="MIDlet-1" value="TestApplication, , TestApplication"/>
	    <attribute name="MIDlet-Jar-Size" value="${jarfile-length}"/>
	    <attribute name="MIDlet-Name" value="TestServer"/>
	    <attribute name="MIDlet-Permissions" 
		value="javax.microedition.io.Connector.socket, javax.microedition.io.Connector.serversocket"/>
        </jadfile>
    </target>

    <target name="midlets" depends="midlet-jar, server-midlet, client-midlet, colloc-midlet"/>

    <target name="all" depends="compile,midlets"/>

    <target name="clean">
        <delete dir="${generated.dir}"/>
	<delete dir="${class.dir}"/>
	<delete dir="./tmp"/>
	<delete file="./TestMIDlet.jar"/>
	<delete quiet="true">
	    <fileset dir="." includes="*.jad"/>
	</delete>
    </target>


</project>
