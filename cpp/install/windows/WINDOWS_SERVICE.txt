This file describes how to install the IceGrid registry, IceGrid node,
and Glacier2 router as Windows services.

1. Review and edit the appropriate configuration file
   (icegridregistry.cfg, icegridnode.cfg or
   glacier2router.cfg). Please make sure to review the notes in the
   Vista section below!

2. We recommend that you use the "Local Service" account to run the
   service. If you decide that you would rather use a standard user
   account then initially this user must be an Administrator if the
   service logs message to the Windows Event Log (see the
   Ice.UseEventLog property).


3. For the IceGrid registry or node create any required data/database
   directory. The sample configuration files use the following two
   directories:

   C:\Documents and Settings\Local Service\Application Data\ZeroC\icegrid\node1
   C:\Documents and Settings\Local Service\Application Data\ZeroC\icegrid\registry

   Under Vista we recommend using:

   C:\Users\Local Service\AppData\ZeroC\icegrid\node1
   C:\Users\Local Service\AppData\ZeroC\icegrid\registry

   Note that once you create these directories you must fix the
   permissions. See the note below.

4. Install the service, for example:

   > icegridregistry --install IceGridRegistry \
     --Ice.Config=C:\Ice-@ver@\config\icegridregistry.cfg

   Installing the service on Windows Vista with UAC enabled requires
   administrator privileges. In this case, run the command shell as
   administrator, right-click the command shell icon and select "Run
   as admin", then execute the installation command.

5. In the Windows Services panel, modify the properties of the new
   service. Change "Log on" to use the 'Local Service' account,
   instead of the Local System Account. You must select the password
   field and clear both entries. See the note below on Windows 2003
   and Vista IceGridNode.

6. Start the service and verify that the service starts properly. Stop
   the service.

7. If you used an account other than "Local Service" then now
   downgrade the account to a regular Users account Restart the
   service.


Windows Server 2003 and Windows Vista
-------------------------------------

On Windows Server 2003 and Windows Vista, if you use a user account
other than "Local Service" to run the IceGrid node service this
account must have permission to read the following registry key.

HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Perflib

Note that this is only necessary if you intend to use an IceGrid
load-balancing policy that relies on CPU usage.  The simplest method
to do this is to edit the permissions of the registry key directly.

1. Start regedit. Navigate to the above key.

2. Right click, select "Permissions..."

3. Add permission for the given account. Select "Read". Press OK.

Another method to do this is to add the user to the "Performance
Monitor Users" group. See the following Microsoft article for details:

http://technet2.microsoft.com/WindowsVista/en/library/ab3b2cfc-b177-43ec-8a4d-0bfac62d88961033.mspx?mfr=true


Permissions
-----------

You must pay careful attention to the permissions of the data and
output directories. As previously mentioned under Vista we recommend
using:

IceGrid.Node.Data=C:\Users\Local Service\AppData\ZeroC\icegrid\node1
IceGrid.Node.Output=C:\Users\Local Service\AppData\ZeroC\icegrid\node1
IceGrid.Registry.Data=C:\Users\Local Service\AppData\ZeroC\icegrid\registry

The node and registry will fail to start unless you take the proper
precautions when creating the directories. For example, to use the
locations shown above first login using an administrator account and
then take the following actions:

1. Start up the file explorer. Navigate to "C:\Users" and create a
   directory named "Local Service" (for XP and Windows 2003 navigate to
   the correct location).

2. Right-click on the directory, select properties, and select the
   security tab.

3. Select Advanced and Edit.

4. Unselect "Include inheritable permissions from this object's
   parent", select Copy.

5. Remove all Permission entries.

7. Add a permission entry for Local Service, SYSTEM and Administrators
   and grant "Full Control" to each.

8. Select ok, and you are done!

Now you can create the icegrid/registry and icegrid/node1
subdirectories without any further action and the correct permissions
will be used.
