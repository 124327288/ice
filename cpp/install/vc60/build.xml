<!--
 **********************************************************************

 Copyright (c) 2003-2005 ZeroC, Inc. All rights reserved.

 This copy of Ice is licensed to you under the terms described in the
 ICE_LICENSE file included in this distribution.

 **********************************************************************
-->

<project name="installer" default="all" basedir=".">

    <!-- Initialize -->
    <target name="init">
	<property name="top.dir" value="../../.."/>

	<!-- Sources -->
	<property name="core.dir" value="${top.dir}/core"/>
	<property name="ice.dir" value="${top.dir}/ice"/>
	<property name="icecs.dir" value="${top.dir}/icecs"/>
	<property name="icej.dir" value="${top.dir}/icej"/>
	<property name="icephp.dir" value="${top.dir}/icephp"/>
	<property name="icepy.dir" value="${top.dir}/icepy"/>
	<property name="icevb.dir" value="${top.dir}/icevb"/>
	<property name="runtime.dir" value="C:/Windows/System32"/>
	<property name="berkeley.dir" value="${top.dir}/db-4.2.52.NC"/>
	<property name="bzip2.dir" value="${top.dir}/bzip2-1.0.2"/>
	<property name="expat.dir" value="${top.dir}/Expat-1.95.8"/>
	<property name="openssl.dir" value="${top.dir}/openssl-0.9.7e"/>
	<property name="stlport.dir" value="${top.dir}/STLPort-4.6.2"/>

	<!-- Targets -->
	<property name="install.dir" value="./install"/>
    </target>

    <!-- Clean up everything -->
    <target name="clean" depends="init">
	<delete dir="${install.dir}"/>
	<delete dir="${install.dir}-packages"/>
    </target>

    <!-- Prepare the install -->
    <target name="setup" depends="init">
	<mkdir dir="${install.dir}"/>
    </target>

    <!-- Ice for C++ Runtime-->
    <target name="ice-cpp-runtime" depends="setup">

	<!-- Binaries -->
	<mkdir dir="${install.dir}/ice-cpp/runtime/bin"/>
	<copy todir="${install.dir}/ice-cpp/runtime/bin">
	    <fileset dir="${ice.dir}/bin">
		<include name="freeze21.dll"/>
		<include name="glacier221.dll"/>
		<include name="ice21.dll"/>
		<include name="icebox21.dll"/>
		<include name="icepack21.dll"/>
		<include name="icepatch221.dll"/>
		<include name="icessl21.dll"/>
		<include name="icestorm21.dll"/>
		<include name="icestormService21.dll"/>
		<include name="iceutil21.dll"/>
		<include name="icexml21.dll"/>
		<include name="slice21.dll"/>
		<include name="dumpdb.exe"/>
		<include name="glacier2router.exe"/>
		<include name="icebox.exe"/>
		<include name="iceboxadmin.exe"/>
		<include name="icecpp.exe"/>
		<include name="icepackadmin.exe"/>
		<include name="icepacknode.exe"/>
		<include name="icepackRegistry.exe"/>
		<include name="icepatch2calc.exe"/>
		<include name="icepatch2client.exe"/>
		<include name="icepatch2server.exe"/>
		<include name="icestormadmin.exe"/>
		<include name="slice2freeze.exe"/>
		<include name="slice2freezej.exe"/>
		<include name="TransformDB.exe"/>
	    </fileset>
	</copy>

    </target>

    <!-- Ice for Java Runtime-->
    <target name="ice-java-runtime" depends="setup">

	<!-- Jars -->
	<mkdir dir="${install.dir}/ice-java/runtime/lib"/>
	<copy file="${icej.dir}/lib/Ice.jar" todir="${install.dir}/ice-java/runtime/lib"/>

    </target>

    <!-- Ice Support -->
    <target name="ice-support" depends="setup">

	<!-- Certificates -->
	<mkdir dir="${install.dir}/ice-support/certs"/>
	<copy todir="${install.dir}/ice-support/certs">
	    <fileset dir="${ice.dir}/certs">
		<include name="**/*.dtd"/>
		<include name="**/*.pem"/>
		<include name="**/*.xml"/>
	    </fileset>
	</copy>

	<!-- Configuration -->
	<mkdir dir="${install.dir}/ice-support/config"/>
	<copy todir="${install.dir}/ice-support/config">
	    <fileset dir="${ice.dir}/config">
		<include name="*.cnf"/>
		<include name="makecerts"/>
	    </fileset>
	</copy>
	
	<!-- Slice -->
	<mkdir dir="${install.dir}/ice-support/slice"/>
	<copy todir="${install.dir}/ice-support/slice">
	    <fileset dir="${ice.dir}/slice">
		<include name="Freeze/*.ice"/>
		<include name="Glacier2/*.ice"/>
		<include name="Ice/*.ice"/>
		<include name="IceBox/*.ice"/>
		<include name="IcePack/*.ice"/>
		<include name="IcePatch2/*.ice"/>
		<include name="IceSSL/*.ice"/>
		<include name="IceStorm/*.ice"/>
	    </fileset>
	</copy>

    </target>

    <!-- Ice for C++ Dev -->
    <target name="ice-cpp-dev" depends="setup">

	<!-- Binaries -->
	<mkdir dir="${install.dir}/ice-cpp/dev/bin"/>
	<copy todir="${install.dir}/ice-cpp/dev/bin">
	    <fileset dir="${ice.dir}/bin">
		<include name="freeze21d.*"/>
		<include name="glacier221d.*"/>
		<include name="ice21d.*"/>
		<include name="icebox21d.*"/>
		<include name="icepack21d.*"/>
		<include name="icepatch221d.*"/>
		<include name="icessl21d.*"/>
		<include name="icestorm21d.*"/>
		<include name="icestormService21d.*"/>
		<include name="iceutil21d.*"/>
		<include name="icexml21d.*"/>
		<include name="slice21d.*"/>
		<include name="slice2cpp.exe"/>
	    </fileset>
	</copy>

	<!-- Libraries -->
	<mkdir dir="${install.dir}/ice-cpp/dev/lib"/>
	<copy todir="${install.dir}/ice-cpp/dev/lib">
	    <fileset dir="${ice.dir}/lib">
	        <include name="freeze.lib"/>
	        <include name="freezed.lib"/>
	        <include name="glacier2.lib"/>
	        <include name="glacier2d.lib"/>
	        <include name="icebox.lib"/>
	        <include name="iceboxd.lib"/>
	        <include name="ice.lib"/>
	        <include name="iced.lib"/>
	        <include name="icepack.lib"/>
	        <include name="icepackd.lib"/>
	        <include name="icepatch2.lib"/>
	        <include name="icepatch2d.lib"/>
	        <include name="icessl.lib"/>
	        <include name="icessld.lib"/>
	        <include name="icestorm.lib"/>
	        <include name="icestormd.lib"/>
	        <include name="icestormservice.lib"/>
	        <include name="icestormserviced.lib"/>
	        <include name="iceutil.lib"/>
	        <include name="iceutild.lib"/>
	        <include name="icexml.lib"/>
	        <include name="icexmld.lib"/>
	        <include name="slice.lib"/>
	        <include name="sliced.lib"/>
	    </fileset>
	</copy>

	<!-- Headers -->
	<mkdir dir="${install.dir}/ice-cpp/dev/include"/>
	<copy todir="${install.dir}/ice-cpp/dev/include">
	    <fileset dir="${ice.dir}/include">
		<include name="Freeze/*.h"/>
		<include name="Glacier2/*.h"/>
		<include name="Ice/*.h"/>
		<include name="IceBox/*.h"/>
		<include name="IcePack/*.h"/>
		<include name="IcePatch2/*.h"/>
		<include name="IceSSL/*.h"/>
		<include name="IceStorm/*.h"/>
		<include name="IceUtil/*.h"/>
		<include name="IceXML/*.h"/>
		<include name="Slice/*.h"/>
	    </fileset>
	</copy>

    </target>

    <!-- Ice for C++ Demo -->
    <target name="ice-cpp-demo" depends="setup">

	<mkdir dir="${install.dir}/ice-cpp/demo/demo_cpp"/>
	<copy todir="${install.dir}/ice-cpp/demo/demo_cpp">
	    <fileset dir="${ice.dir}/demo">
		<exclude name="**/*.exe"/>
		<exclude name="**/*.ilk"/>
		<exclude name="**/*.pdb"/>
		<exclude name="**/.depend"/>
		<exclude name="**/.dummy"/>
		<exclude name="**/Makefile"/>
		<exclude name="**/Debug/**"/>
		<exclude name="**/Release/**"/>
	    </fileset>
	</copy>

    </target>

    <!-- Ice for Java -->
    <target name="ice-java-dev" depends="setup">

	<!-- Ant classes -->
	<mkdir dir="${install.dir}/ice-java/dev/ant"/>
	<copy todir="${install.dir}/ice-java/dev/ant">
	    <fileset dir="${icej.dir}/ant">
		<include name="**/*.class"/>
	    </fileset>
	</copy>

	<!-- Binaries -->
	<mkdir dir="${install.dir}/ice-java/dev/bin"/>
	<copy todir="${install.dir}/ice-java/dev/bin">
	    <fileset dir="${ice.dir}/bin">
		<include name="slice2java.exe"/>
	    </fileset>
	</copy>

	<!-- Configuration -->
	<mkdir dir="${install.dir}/ice-java/dev/config"/>
	<copy file="${icej.dir}/config/build.properties" todir="${install.dir}/ice-java/dev/config"/>

    </target>

    <!-- Ice for Java Demo -->
    <target name="ice-java-demo" depends="setup">

	<mkdir dir="${install.dir}/ice-java/demo/demo_java"/>
	<copy todir="${install.dir}/ice-java/demo/demo_java">
	    <fileset dir="${icej.dir}/demo">
		<exclude name="**/.dummy"/>
		<exclude name="**/classes/**"/>
		<exclude name="**/generated/**"/>
	    </fileset>
	</copy>

    </target>

    <!-- Ice for Python Runtime -->
    <target name="ice-python-runtime" depends="setup">

	<!-- Binaries -->
	<mkdir dir="${install.dir}/ice-python/runtime/bin"/>
	<copy todir="${install.dir}/ice-python/runtime/bin">
	    <fileset dir="${icepy.dir}/bin">
		<include name="*.dll"/>
	    </fileset>
	</copy>

	<!-- Python Files -->
	<mkdir dir="${install.dir}/ice-python/runtime/python"/>
	<copy todir="${install.dir}/ice-python/runtime/python">
	    <fileset dir="${icepy.dir}/python">
		<include name="**/*.py"/>
	    </fileset>
	</copy>

    </target>

    <!-- Ice for Python Dev -->
    <target name="ice-python-dev" depends="setup">

	<!-- Binaries -->
	<mkdir dir="${install.dir}/ice-python/dev/bin"/>
	<copy todir="${install.dir}/ice-python/dev/bin">
	    <fileset dir="${ice.dir}/bin">
		<include name="slice2py.exe"/>
	    </fileset>
	</copy>

    </target>

    <!-- Ice for Python Demo -->
    <target name="ice-python-demo" depends="setup">

	<mkdir dir="${install.dir}/ice-python/demo/demo_python"/>
	<copy todir="${install.dir}/ice-python/demo/demo_python">
	    <fileset dir="${icepy.dir}/demo">
		<include name="**"/>
	    </fileset>
	</copy>

    </target>

    <!-- Ice PHP Dynamic Extension -->
    <target name="ice-php-extension" depends="setup">

	<mkdir dir="${install.dir}/ice-php/extension/bin"/>
	<copy file="${icephp.dir}/src/ice/Release/php_ice.dll" todir="${install.dir}/ice-php/extension/bin"/>

    </target>

    <!-- Ice PHP Demo -->
    <target name="ice-php-demo" depends="setup">

	<mkdir dir="${install.dir}/ice-php/demo/demo_php"/>
	<copy todir="${install.dir}/ice-php/demo/demo_php">
	    <fileset dir="${icephp.dir}/demo">
		<include name="**"/>
	    </fileset>
	</copy>

    </target>

    <!-- Berkeley DB Dev Kit -->
    <target name="berkeley-dev" depends="setup">

	<mkdir dir="${install.dir}/berkeley/dev/bin"/>
	<copy todir="${install.dir}/berkeley/dev/bin">
	    <fileset dir="${berkeley.dir}/build_win32/Debug">
		<include name="*.dll"/>
		<include name="*.pdb"/>
	    </fileset>
	</copy>

	<mkdir dir="${install.dir}/berkeley/dev/lib"/>
	<copy todir="${install.dir}/berkeley/dev/lib">
	    <fileset dir="${berkeley.dir}/build_win32/Debug">
		<include name="*.lib"/>
	    </fileset>
	    <fileset dir="${berkeley.dir}/build_win32/Release">
		<include name="*.lib"/>
	    </fileset>
	</copy>

	<mkdir dir="${install.dir}/berkeley/dev/include"/>
	<copy todir="${install.dir}/berkeley/dev/include">
	    <fileset dir="${berkeley.dir}/build_win32">
		<include name="db.h"/>
		<include name="db_cxx.h"/>
	    </fileset>
	</copy>

    </target>

    <!-- Berkeley DB Runtime -->
    <target name="berkeley-runtime" depends="setup">

	<mkdir dir="${install.dir}/berkeley/runtime/bin"/>
	<copy todir="${install.dir}/berkeley/runtime/bin">
	    <fileset dir="${berkeley.dir}/build_win32/Release">
		<include name="*.dll"/>
		<include name="db_archive.exe"/>
		<include name="db_checkpoint.exe"/>
		<include name="db_deadlock.exe"/>
		<include name="db_dump.exe"/>
		<include name="db_load.exe"/>
		<include name="db_printlog.exe"/>
		<include name="db_recover.exe"/>
		<include name="db_stat.exe"/>
		<include name="db_upgrade.exe"/>
		<include name="db_verify.exe"/>
	    </fileset>
	</copy>

	<mkdir dir="${install.dir}/berkeley/runtime/lib"/>
	<copy todir="${install.dir}/berkeley/runtime/lib">
	    <fileset dir="${berkeley.dir}/build_win32/Release">
		<include name="db.jar"/>
	    </fileset>
	</copy>

    </target>

    <!-- bZip2 Dev Kit -->
    <target name="bzip2-dev" depends="setup">

	<mkdir dir="${install.dir}/bzip2/dev/lib"/>
	<copy file="${bzip2.dir}/libbz2.lib" todir="${install.dir}/bzip2/dev/lib"/>
	<!-- TODO include the debug lib? -->

	<mkdir dir="${install.dir}/bzip2/dev/include"/>
	<copy file="${bzip2.dir}/bzlib.h" todir="${install.dir}/bzip2/dev/include"/>

    </target>

    <!-- eXpat Dev Kit -->
    <target name="expat-dev" depends="setup">

	<mkdir dir="${install.dir}/expat/dev/lib"/>
	<copy todir="${install.dir}/expat/dev/lib">
	    <fileset dir="${expat.dir}/Source/lib/Release">
		<include name="*.lib"/>
	    </fileset>
	</copy>
	<copy todir="${install.dir}/expat/dev/lib">
	    <fileset dir="${expat.dir}/Source/lib/Release-w">
		<include name="*.lib"/>
	    </fileset>
	</copy>

	<mkdir dir="${install.dir}/expat/dev/include"/>
	<copy todir="${install.dir}/expat/dev/include">
	    <fileset dir="${expat.dir}/Source/lib">
		<include name="expat.h"/>
		<include name="expat_external.h"/>
	    </fileset>
	</copy>

    </target>

    <!-- eXpat Runtime -->
    <target name="expat-runtime" depends="setup">

	<mkdir dir="${install.dir}/expat/runtime/bin"/>
	<copy todir="${install.dir}/expat/runtime/bin">
	    <fileset dir="${expat.dir}/Source/lib/Release">
		<include name="*.dll"/>
	    </fileset>
	</copy>
	<copy todir="${install.dir}/expat/runtime/bin">
	    <fileset dir="${expat.dir}/Source/lib/Release-w">
		<include name="*.dll"/>
	    </fileset>
	</copy>

    </target>

    <!-- OpenSSL Dev Kit -->
    <target name="openssl-dev" depends="setup">

	<mkdir dir="${install.dir}/openssl/dev/lib"/>
	<copy todir="${install.dir}/openssl/dev/lib">
	    <fileset dir="${openssl.dir}/out32dll">
		<include name="*.lib"/>
	    </fileset>
	</copy>

	<mkdir dir="${install.dir}/openssl/dev/include"/>
	<copy todir="${install.dir}/openssl/dev/include">
	    <fileset dir="${openssl.dir}/include">
		<include name="**"/>
	    </fileset>
	</copy>

    </target>

    <!-- OpenSSL Runtime -->
    <target name="openssl-runtime" depends="setup">
    
	<mkdir dir="${install.dir}/openssl/runtime/bin"/>
	<copy todir="${install.dir}/openssl/runtime/bin">
	    <fileset dir="${openssl.dir}/out32dll">
		<include name="*.dll"/>
		<include name="openssl.exe"/>
	    </fileset>
	</copy>

    </target>

    <!-- STLPort Dev Kit -->
    <target name="stlport-dev" depends="setup">

	<mkdir dir="${install.dir}/stlport/dev/bin"/>
	<copy todir="${install.dir}/stlport/dev/bin">
	    <fileset dir="${stlport.dir}/lib">
		<include name="*debug*.dll"/>
		<include name="*.pdb"/>
	    </fileset>
	</copy>

	<mkdir dir="${install.dir}/stlport/dev/lib"/>
	<copy todir="${install.dir}/stlport/dev/lib">
	    <fileset dir="${stlport.dir}/lib">
		<include name="*debug*.lib"/>
		<exclude name="*static*.lib"/>
	    </fileset>
	</copy>

	<mkdir dir="${install.dir}/stlport/dev/include"/>
	<copy todir="${install.dir}/stlport/dev/include/stlport">
	    <fileset dir="${stlport.dir}/stlport">
		<include name="**"/>
	    </fileset>
	</copy>

    </target>

    <!-- STLPort Runtime -->
    <target name="stlport-runtime" depends="setup">

	<mkdir dir="${install.dir}/stlport/runtime/bin"/>
	<copy todir="${install.dir}/stlport/runtime/bin">
	    <fileset dir="${stlport.dir}/lib">
		<include name="*.dll"/>
		<exclude name="*debug*.dll"/>
	    </fileset>
	</copy>

    </target>

    <target name="vc60-packages" 
            depends="berkeley-dev,
		     berkeley-runtime,
		     bzip2-dev,
		     expat-dev,
		     expat-runtime,
		     openssl-dev,
		     openssl-runtime,
		     stlport-dev,
		     stlport-runtime">
	<mkdir dir="${install.dir}/microsoft/runtime/bin"/>
	<copy file="${runtime.dir}/msvcrt.dll" todir="${install.dir}/microsoft/runtime/bin"/>
	<copy file="${runtime.dir}/msvcp60.dll" todir="${install.dir}/microsoft/runtime/bin"/>
     </target>

    <target name="vc60" 
            depends="vc60-packages,
	             ice-support,
		     ice-cpp-runtime,
		     ice-cpp-dev,
		     ice-cpp-demo,
		     ice-java-runtime,
		     ice-java-dev,
		     ice-java-demo,
		     ice-python-runtime,
		     ice-python-dev,
		     ice-python-demo,
		     ice-php-extension,
		     ice-php-demo"/>

    <target name="merge-modules">
	<exec dir="." executable="ISCmdBld.exe">
	    <arg line="-p BerkeleyDBDevKit.ism -c COMP -a ZEROC -R BERKELEYDB_DEV_KIT"/>
	</exec>
	<exec dir="." executable="ISCmdBld.exe">
	    <arg line="-p BerkeleyDBRuntime.ism -c COMP -a ZEROC -R BERKELEYDB_RUNTIME"/>
	</exec>
	<exec dir="." executable="ISCmdBld.exe">
	    <arg line="-p BZip2DevKit.ism -c COMP -a ZEROC -R BZIP2_DEV_KIT"/>
	</exec>
	<exec dir="." executable="ISCmdBld.exe">
	    <arg line="-p ExpatDevKit.ism -c COMP -a ZEROC -R EXPAT_DEV_KIT"/>
	</exec>
	<exec dir="." executable="ISCmdBld.exe">
	    <arg line="-p ExpatRuntime.ism -c COMP -a ZEROC -R EXPAT_RUNTIME"/>
	</exec>
	<exec dir="." executable="ISCmdBld.exe">
	    <arg line="-p OpenSSLDevKit.ism -c COMP -a ZEROC -R OPENSSL_DEV_KIT"/>
	</exec>
	<exec dir="." executable="ISCmdBld.exe">
	    <arg line="-p OpenSSLRuntime.ism -c COMP -a ZEROC -R OPENSSL_RUNTIME"/>
	</exec>
	<exec dir="." executable="ISCmdBld.exe">
	    <arg line="-p STLPortDevKit.ism -c COMP -a ZEROC -R STLPORT_DEV_KIT"/>
	</exec>
	<exec dir="." executable="ISCmdBld.exe">
	    <arg line="-p STLPortRuntime.ism -c COMP -a ZEROC -R STLPORT_RUNTIME"/>
	</exec>
    </target>

    <target name="vc60-merge-modules" depends="setup">
	<zip destfile="${install.dir}/ThirdPartyMergeModules-2.1.0-VC60.zip">
	    <zipfileset dir="BerkeleyDBDevKit/ZEROC/BERKELEYDB_DEV_KIT/DiskImages/DISK1" includes="*.msm"/>
	    <zipfileset dir="BerkeleyDBRuntime/ZEROC/BERKELEYDB_RUNTIME/DiskImages/DISK1" includes="*.msm"/>
	    <zipfileset dir="BZip2DevKit/ZEROC/BZIP2_DEV_KIT/DiskImages/DISK1" includes="*.msm"/>
	    <zipfileset dir="ExpatDevKit/ZEROC/EXPAT_DEV_KIT/DiskImages/DISK1" includes="*.msm"/>
	    <zipfileset dir="ExpatRuntime/ZEROC/EXPAT_RUNTIME/DiskImages/DISK1" includes="*.msm"/>
	    <zipfileset dir="OpenSSLDevKit/ZEROC/OPENSSL_DEV_KIT/DiskImages/DISK1" includes="*.msm"/>
	    <zipfileset dir="OpenSSLRuntime/ZEROC/OPENSSL_RUNTIME/DiskImages/DISK1" includes="*.msm"/>
	    <zipfileset dir="STLPortDevKit/ZEROC/STLPORT_DEV_KIT/DiskImages/DISK1" includes="*.msm"/>
	    <zipfileset dir="STLPortRuntime/ZEROC/STLPORT_RUNTIME/DiskImages/DISK1" includes="*.msm"/>
	</zip>
    </target>

    <target name="vc60-installer" depends="vc60">
	<exec dir="." executable="ISCmdBld.exe">
	    <arg line="-p Ice-2.1.0-VC60.ism -r ICE_MSI -c COMP -a ZEROC"/>
	</exec>
    </target>

    <target name="vc60-packages-installer" depends="vc60-packages">
	<exec dir="." executable="ISCmdBld.exe">
	    <arg line="-p ThirdParty-2.1.0-VC60.ism -r THIRD_PARTY_MSI -c COMP -a ZEROC"/>
	</exec>
    </target>

    <!--<target name="all" depends="vc60-installer,vc60-packages-installer"/>-->
    <target name="all" depends="vc60"/>

</project>
